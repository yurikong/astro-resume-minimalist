---
import type { IProject } from "~types/project"
import { Repository } from "~/types/repository"
import { mostRecentYearComparator } from "~utils/comparators"
import ProjectDetails from "./ProjectDetails.astro"
import AppLink from "~components/AppLink.astro"

interface Props {
  class?: string
}
const { class: className } = Astro.props

const site: string = import.meta.env.DEV ? `http://localhost:${import.meta.env.PORT}` : import.meta.env.SITE
const apiUrl: string = `${site}${import.meta.env.BASE_URL}/projects.json`
const projectDetailsList: IProject[] = []

try {
  const response = await fetch(apiUrl)
  const data: IProject[] = await response.json()
  data.forEach((it) => {
    if (it.repository) {
      const { owner, name } = it.repository
      it.repository = new Repository(owner, name)
    }
  })
  const selectedProjects: IProject[] = data.toSorted(mostRecentYearComparator).slice(0, 5)
  projectDetailsList.push(...selectedProjects)
} catch (error) {
  console.error(error)
}
---

<!-- Projects -->
<section class={className}>
  <h2
    class="sticky top-0 z-20 mb-4 bg-gray-100 px-6 py-5 text-(sm gray-800) font-semibold tracking-widest uppercase -mx-6"
  >
    projects
  </h2>
  <ul>
    {
      projectDetailsList.map((it) => (
        <li class="mb-16 last-of-type:mb-0">
          <ProjectDetails {...it} />
        </li>
      ))
    }
  </ul>

  <!-- View All Projects -->
  <AppLink
    class="mt-24 block text-gray-800 font-semibold capitalize"
    url="/project"
    showSuffixIcon
    suffixIconClassName="i-ri:arrow-right-line"
  >
    view all projects
  </AppLink>
</section>
